@{
    ViewData["Title"] = "My Enrolled Courses";
}

<style>
    /* Attendance Grid Styling */
    .attendance-grid {
        display: flex;
        gap: 3px;
        margin-top: 5px;
    }

    .att-box {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        border: 1px solid #dee2e6;
    }

    .bg-unmarked {
        background-color: #e9ecef;
    }
    /* Grey */
    .bg-present {
        background-color: #198754;
    }
    /* Green */
    .bg-absent {
        background-color: #dc3545;
    }
    /* Red */
</style>

<div class="container mt-5">
    <div class="card shadow border-0">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0 fw-bold text-primary">
                <i class="bi bi-book-half me-2"></i>My Academic Records
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Course ID</th>
                            <th>Course Name</th>
                            <th>Obtained Marks (/100)</th>
                            <th>Attendance (16 Week Tracker)</th>
                        </tr>
                    </thead>
                    <tbody id="coursesTableBody">
                        <tr>
                            <td colspan="4" class="text-center">
                                <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                                <span class="ms-2">Fetching your records...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            loadStudentCourses();
        });

        function loadStudentCourses() {
            $.ajax({
                url: '/Candidate/HandleAction',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ operaid: 17 }),
                success: function (res) {
                    if (res.success) {
                        let html = '';
                        let data = res.data || [];

                        if (data.length === 0) {
                            html = '<tr><td colspan="4" class="text-center text-muted">You are not enrolled in any courses yet.</td></tr>';
                        } else {
                            data.forEach(item => {
                                let code = item.CourseCode || "N/A";
                                let name = item.CourseName || "N/A";
                                let marks = item.TotalMarks ?? 0;
                                let history = item.AttendanceHistory || [];
                                let totalW = 16;

                                let barColor = marks >= 55 ? 'bg-success' : 'bg-danger';

                                let attendanceHtml = '<div class="attendance-grid">';
                                for (let i = 1; i <= totalW; i++) {
                                    let weekRecord = history.find(h => h.WeekNumber === i);
                                    let statusClass = 'bg-unmarked';
                                    let displayStatus = 'Unmarked';

                                    if (weekRecord) {
                                        if (weekRecord.Status === "Present") {
                                            statusClass = 'bg-present';
                                            displayStatus = 'Present';
                                        } else if (weekRecord.Status === "Absent") {
                                            statusClass = 'bg-absent';
                                            displayStatus = 'Absent';
                                        }
                                    }

                                    attendanceHtml += `<div class="att-box ${statusClass}" title="Week ${i}: ${displayStatus}"></div>`;
                                }
                                attendanceHtml += '</div>';

                                let presentCount = history.filter(h => h.Status === "Present").length;

                                html += `
                                    <tr>
                                        <td><span class="fw-bold text-white">${code}</span></td>
                                        <td>${name}</td>
                                        <td>
                                            <span class="fs-6 fw-bold ${marks >= 55 ? 'text-success' : 'text-danger'}">${marks}</span>
                                            <div class="progress mt-1" style="height: 6px; width: 120px;">
                                                <div class="progress-bar ${barColor}" role="progressbar" style="width: ${marks}%"></div>
                                            </div>
                                        </td>
                                        <td>
                                            <small class="text-muted d-block mb-1">${presentCount} of ${totalW} weeks present</small>
                                            ${attendanceHtml}
                                        </td>
                                    </tr>`;
                            });
                        }
                        $('#coursesTableBody').html(html);
                    }
                },
                error: function(err) {
                    $('#coursesTableBody').html('<tr><td colspan="4" class="text-center text-danger">Error loading records.</td></tr>');
                }
            });
        }
    </script>
}