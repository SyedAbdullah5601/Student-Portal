@{
    ViewData["Title"] = "User Management";
}

<div class="container mt-4">
    <div class="card shadow border-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i> System Users</h5>
            <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" id="userSearch" class="form-control" placeholder="Search users..." onkeyup="filterTable()">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="userTable">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Contact</th>
                            <th class="text-end px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userListBody">
                        <tr><td colspan="5" class="text-center py-4">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Edit User Profile</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_Id">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">First Name</label>
                        <input type="text" id="edit_FirstName" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Last Name</label>
                        <input type="text" id="edit_LastName" class="form-control">
                    </div>
                    <div class="col-12">
                        <label class="form-label small fw-bold">Email</label>
                        <input type="email" id="edit_Email" class="form-control">
                    </div>
                    <div class="col-12">
                        <label class="form-label small fw-bold">Phone Number</label>
                        <input type="text" id="edit_Phone" class="form-control">
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let allUsersData = [];

        $(document).ready(function() {
            loadUsers();
        });

        function loadUsers() {
            $.ajax({
                url: '/Candidate/HandleAction',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ operaid: 20 }),
                success: function(res) {
                    if (res.success) {
                        allUsersData = res.data;
                        let rows = res.data.map(u => {
                            let role = u.RoleName || 'Student';
                            let badgeClass = role === 'Admin' ? 'bg-warning text-dark' : (role === 'Faculty' ? 'bg-success' : 'bg-primary');

                            return `
                                <tr>
                                    <td class="ps-4">
                                        <div class="fw-bold">${u.FirstName} ${u.LastName}</div>
                                        <small class="text-muted">Joined: ${u.JoinedDate}</small>
                                    </td>
                                    <td><code>${u.Username}</code></td>
                                    <td><span class="badge ${badgeClass}">${role}</span></td>
                                    <td>
                                        <div class="small"><i class="bi bi-envelope me-1"></i>${u.Email}</div>
                                        <div class="small text-muted"><i class="bi bi-phone me-1"></i>${u.PhoneNo}</div>
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-outline-primary me-1"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editUserModal"
                                                onclick="prepareEditModal(${u.CandidateId})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${u.CandidateId})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>`;
                        }).join('');
                        $('#userListBody').html(rows || '<tr><td colspan="5" class="text-center">No users found.</td></tr>');
                    }
                }
            });
        }

        function prepareEditModal(id) {
            const user = allUsersData.find(u => u.CandidateId === id);
            if (user) {
                $('#edit_Id').val(user.CandidateId);
                $('#edit_FirstName').val(user.FirstName);
                $('#edit_LastName').val(user.LastName);
                $('#edit_Email').val(user.Email);
                $('#edit_Phone').val(user.PhoneNo);
            }
        }

        function updateUser() {
            const data = {
                operaid: 22,
                CandidateId: parseInt($('#edit_Id').val()),
                FirstName: $('#edit_FirstName').val(),
                LastName: $('#edit_LastName').val(),
                Email: $('#edit_Email').val(),
                PhoneNo: $('#edit_Phone').val()
            };

            $.ajax({
                url: '/Candidate/HandleAction',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(res) {
                    if (res.success) {
                        const modalElement = document.getElementById('editUserModal');
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                        alert("User updated successfully!");
                        loadUsers();
                    } else {
                        alert("Error: " + res.message);
                    }
                },
                error: function(xhr) {
                    console.error("Update failed:", xhr.responseText);
                    alert("A server error occurred.");
                }
            });
        }

        function deleteUser(id) {
            if (confirm("Are you sure? This will wipe all history for this user.")) {
                $.ajax({
                    url: '/Candidate/HandleAction',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ operaid: 21, candidateId: id }),
                    success: function(res) {
                        if (res.success) loadUsers();
                        else alert(res.message);
                    }
                });
            }
        }

        function filterTable() {
            let val = $('#userSearch').val().toLowerCase();
            $("#userListBody tr").filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(val) > -1)
            });
        }
    </script>
}